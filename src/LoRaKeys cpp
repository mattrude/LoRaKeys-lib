#include <Arduino.h>
#include <Wire.h>
#include "LoRaKeys.h"

LoRaKeys::LoRaKeys() {
  loadLoRaKeys();
}

int LoRaKeys::readEEPROM(unsigned int eeaddress ){
  int deviceaddress = 0x50;
  byte rdata = 0xFF;
  Wire.beginTransmission(deviceaddress);
  Wire.write((int)(eeaddress >> 8));   // MSB
  Wire.write((int)(eeaddress & 0xFF)); // LSB
  Wire.endTransmission();
  Wire.requestFrom(deviceaddress,1);
  if (Wire.available()) { rdata = Wire.read(); }
  return rdata;
};

void LoRaKeys::loadLoRaKeys(void) {
  if ( readEEPROM(0) == 0x01 ) {
    Serial.println("ABP:");
    byte x = 1;
    for (byte i = 0; i < 4; ++i) {
      eepDEVADD[i] = readEEPROM(x);
      ++x;
    }

    x = 5;
    for (byte i = 0; i < 16; ++i) {
      eepNWKKEY[i] = readEEPROM(x);
      ++x;
    }

    x = 21;
    for (byte i = 0; i < 16; ++i) {
      eepAPPKEY[i] = readEEPROM(x);
      ++x;
    }
    buildLoRaKeysABP();  
  } else if ( readEEPROM(0) == 0x02 ) {
    Serial.println("OTAA:");
    byte x = 1;
    for (byte i = 0; i < 8; ++i) {
      eepAPPEUI[i] = readEEPROM(x);
      ++x;
    }

    x = 9;
    for (byte i = 0; i < 8; ++i) {
      eepDEVEUI[i] = readEEPROM(x);
      ++x;
    }

    x = 17;
    for (byte i = 0; i < 16; ++i) {
      eepAPPKEY[i] = readEEPROM(x);
      ++x;
    }
    buildLoRaKeysOTTA();
  } else {
    Serial.println("Unknown");
  }
}

int LoRaKeys::buildLoRaKeysOTTA(void) {
  static const u1_t PROGMEM APPEUI[8]  = { eepAPPEUI[7], eepAPPEUI[6], eepAPPEUI[5], eepAPPEUI[4],
                                         eepAPPEUI[3], eepAPPEUI[2], eepAPPEUI[1], eepAPPEUI[0] };
  static const u1_t PROGMEM DEVEUI[8]  = { eepDEVEUI[7], eepDEVEUI[6], eepDEVEUI[5], eepDEVEUI[4],
                                           eepDEVEUI[3], eepDEVEUI[2], eepDEVEUI[1], eepDEVEUI[0] };
  static const u1_t PROGMEM APPKEY[16] = { eepAPPKEY[0], eepAPPKEY[1], eepAPPKEY[2], eepAPPKEY[3],
                                          eepAPPKEY[4], eepAPPKEY[5], eepAPPKEY[6], eepAPPKEY[7],
                                          eepAPPKEY[8], eepAPPKEY[9], eepAPPKEY[10], eepAPPKEY[11],
                                          eepAPPKEY[12], eepAPPKEY[13], eepAPPKEY[14], eepAPPKEY[15] };
}

int LoRaKeys::buildLoRaKeysABP(void) {

  static const u1_t PROGMEM DEVADD[4]  = { eepDEVADD[3], eepDEVADD[2], eepDEVADD[1], eepDEVADD[0] };
  static const u1_t PROGMEM NWKKEY[16]  = { eepNWKKEY[0], eepNWKKEY[1], eepNWKKEY[2], eepNWKKEY[3],
                                            eepNWKKEY[4], eepNWKKEY[5], eepNWKKEY[6], eepNWKKEY[7],
                                            eepNWKKEY[8], eepNWKKEY[9], eepNWKKEY[10], eepNWKKEY[11],
                                            eepNWKKEY[12], eepNWKKEY[13], eepNWKKEY[14], eepNWKKEY[15] };
  static const u1_t PROGMEM APPKEY[16] = { eepAPPKEY[0], eepAPPKEY[1], eepAPPKEY[2], eepAPPKEY[3],
                                            eepAPPKEY[4], eepAPPKEY[5], eepAPPKEY[6], eepAPPKEY[7],
                                            eepAPPKEY[8], eepAPPKEY[9], eepAPPKEY[10], eepAPPKEY[11],
                                            eepAPPKEY[12], eepAPPKEY[13], eepAPPKEY[14], eepAPPKEY[15] };
}